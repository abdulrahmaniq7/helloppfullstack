pipeline {
  agent any

  environment {
    DOCKER_BUILDKIT = 1   // Use Docker BuildKit for faster builds
  }

  stages {
    stage('Clean Workspace') {
      steps {
        deleteDir()  // Ensure clean workspace
      }
    }

    stage('Checkout') {
      steps {
        // This checks out the code from your configured Git SCM
        checkout scm
      }
    }

    stage('Build & Deploy') {
      steps {
        script {
          try {
            echo "Stopping existing containers..."
            sh 'docker-compose down || true'  // Ensure it doesn't fail if containers are not running
            echo "Building and starting containers..."
            sh 'docker-compose up --build -d'
          } catch (e) {
            echo "Error during Build & Deploy: ${e}"
            error("Build & Deploy failed")
          }
        }
      }
    }
  }
}
